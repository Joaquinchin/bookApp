name: Docker ‚Äì Build & Publish (GHCR)

# DESCRIPCI√ìN DEL WORKFLOW:
# Este workflow automatiza la creaci√≥n y publicaci√≥n de im√°genes Docker
# para la aplicaci√≥n BookApp cuando se hace push a la rama principal.
# 
# QU√â HACE:
# 1. Construye una imagen Docker optimizada usando multi-stage build
# 2. Publica la imagen en GitHub Container Registry (ghcr.io)
# 3. Genera m√∫ltiples tags para diferentes prop√≥sitos
# 4. Proporciona feedback autom√°tico en PRs cuando corresponde

on:
  push:
    branches: [main, master]  # Solo se ejecuta en push a ramas principales

permissions:
  contents: read              # Permiso para leer el c√≥digo del repositorio
  packages: write            # Permiso para escribir en GitHub Container Registry
  pull-requests: write       # Permiso para comentar en Pull Requests

# Configuraci√≥n de concurrencia: 
# Cancela builds anteriores si hay un nuevo push para ahorrar recursos
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker:
    name: Build & Push image
    runs-on: ubuntu-latest

    steps:
      # PASO 1: Descargar c√≥digo fuente del repositorio
      - name: Checkout
        uses: actions/checkout@v4
        
      # PASO 2: Extraer versi√≥n del package.json para crear tags sem√°nticos
      # Esto permite tener im√°genes versionadas (ej: v0.1.0)
      - name: Read version
        id: meta
        run: echo "version=$(node -p 'require(\"./package.json\").version')" >> $GITHUB_OUTPUT

      # PASO 3: Configurar Docker Buildx (constructor avanzado de Docker)
      # Buildx permite features avanzadas como multi-platform builds y cache
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # PASO 3.5: Cache de layers de Docker para builds m√°s r√°pidos
      # Reutiliza layers entre builds para reducir tiempo de construcci√≥n
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # PASO 4: Autenticarse en GitHub Container Registry
      # Usa el token autom√°tico de GitHub para publicar im√°genes
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}           # Usuario que hizo el push
          password: ${{ secrets.GITHUB_TOKEN }}   # Token autom√°tico de GitHub

      # PASO 5: Construir y publicar imagen Docker con m√∫ltiples tags
      # Se crean 3 tags diferentes para cubrir distintos casos de uso
      # Utiliza cache manual con buildx para compatibilidad con conversi√≥n de nombres
      - name: Build & Push
        run: |
          # Preparar nombre de imagen (debe estar en min√∫sculas para GHCR)
          IMAGE=ghcr.io/${{ github.repository_owner }}/bookapp
          IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          
          # Obtener informaci√≥n para tags
          SHA=${{ github.sha }}           # Hash del commit actual
          VER=${{ steps.meta.outputs.version }}  # Versi√≥n desde package.json

          # CONSTRUIR imagen con m√∫ltiples tags y cache:
          # - latest: Para producci√≥n y deployments autom√°ticos
          # - v{version}: Para releases espec√≠ficas (ej: v1.2.3) 
          # - {commit-sha}: Para trazabilidad de cada cambio
          docker buildx build \
            --push \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t $IMAGE:latest \
            -t $IMAGE:v$VER \
            -t $IMAGE:$SHA \
            .
          
      # Mover cache para pr√≥ximo build
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # PASO 6: Comentar √©xito en Pull Request (si aplica)
      # Proporciona feedback autom√°tico con informaci√≥n de las im√°genes creadas
      - name: Comment Docker Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}'.substring(0, 7);
            const version = '${{ steps.meta.outputs.version }}';
            const image = 'ghcr.io/${{ github.repository_owner }}/bookapp'.toLowerCase();
            
            // Solo comentar si el trigger viene de un Pull Request
            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `**üê≥ Docker imagen creada exitosamente!** \n\n` +
                      `**üì¶ Im√°genes disponibles:**\n` +
                      `- \`${image}:latest\` ‚Üê Producci√≥n\n` +
                      `- \`${image}:v${version}\` ‚Üê Versi√≥n espec√≠fica\n` +
                      `- \`${image}:${sha}\` ‚Üê Commit espec√≠fico\n\n` +
                      `**üöÄ Para ejecutar localmente:**\n` +
                      `\`\`\`bash\n` +
                      `docker run -p 3000:3000 ${image}:latest\n` +
                      `\`\`\`\n\n` +
                      `[üìã Ver en GitHub Container Registry](https://github.com/${{ github.repository_owner }}/bookApp/pkgs/container/bookapp)`
              });
            }
            
      # PASO 7: Comentar error en Pull Request (si aplica)  
      # Proporciona informaci√≥n de debugging cuando el build falla
      - name: Comment Docker Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `**‚ùå Docker build fall√≥!** \n\n` +
                      `**üîç Posibles causas:**\n` +
                      `- Error en el Dockerfile\n` +
                      `- Problema con dependencias en el container\n` +
                      `- Falla en \`npm run build\` dentro del container\n` +
                      `- Error de permisos en GitHub Container Registry\n\n` +
                      `**üìä [Ver logs detallados](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**\n\n` +
                      `**üí° Tip:** Ejecuta \`docker build . -t test-build\` localmente para reproducir el error.`
              });
            }
